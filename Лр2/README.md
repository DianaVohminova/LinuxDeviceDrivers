# SPAN-–¥—Ä–∞–π–≤–µ—Ä –¥–ª—è Linux

–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **–º–æ–¥—É–ª—å —è–¥—Ä–∞ Linux**, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å **SPAN (Switched Port Analyzer)** ‚Äî –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ —Å –æ–¥–Ω–æ–≥–æ —Å–µ—Ç–µ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ –¥—Ä—É–≥–æ–π. –ú–æ–¥—É–ª—å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —É—á–µ–±–Ω—ã—Ö –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ü–µ–ª—è—Ö, –≤ —Ä–∞–º–∫–∞—Ö –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ ¬´–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä–∞–π–≤–µ—Ä–æ–≤¬ª.

## üéØ –¶–µ–ª—å

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥—Ä–∞–π–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π:
- –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç **–≤—Ö–æ–¥—è—â–∏–µ –∏ –∏—Å—Ö–æ–¥—è—â–∏–µ** IP-–ø–∞–∫–µ—Ç—ã –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Å–µ—Ç–µ–≤–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ;
- —Å–æ–∑–¥–∞—ë—Ç –∏—Ö –∫–æ–ø–∏—é;
- –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–ø–∏—é –Ω–∞ **–≤—Ç–æ—Ä–æ–π (–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π) –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞.

–ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–∞—Ö –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞.

## üß† –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Netfilter framework** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –ø–∞–∫–µ—Ç–æ–≤ –≤ —è–¥—Ä–µ Linux. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –¥–≤–∞ —Ö—É–∫–∞:
- `NF_INET_PRE_ROUTING` ‚Äî –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ **–≤—Ö–æ–¥—è—â–∏—Ö** –ø–∞–∫–µ—Ç–æ–≤;
- `NF_INET_POST_ROUTING` ‚Äî –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ **–∏—Å—Ö–æ–¥—è—â–∏—Ö** –ø–∞–∫–µ—Ç–æ–≤.

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–∞–∫–µ—Ç–∞, –ø—Ä–æ—Ö–æ–¥—è—â–µ–≥–æ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (`src_if`), –º–æ–¥—É–ª—å:
1. –°–æ–∑–¥–∞—ë—Ç –∫–æ–ø–∏—é –ø–∞–∫–µ—Ç–∞ —Å –ø–æ–º–æ—â—å—é `skb_copy()`;
2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ü–µ–ª–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (`dst_if`);
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–ø–∏—é —á–µ—Ä–µ–∑ `dev_queue_xmit()`.

–ò—Å—Ö–æ–¥–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ **–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è** –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Å–µ—Ç–µ–≤–æ–º —Å—Ç–µ–∫–µ.

## üì¶ –°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞

- `span_driver.c` ‚Äî –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –º–æ–¥—É–ª—è —è–¥—Ä–∞;
- `Makefile` ‚Äî —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏ –º–æ–¥—É–ª—è;
- `README.md` ‚Äî –¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª.

## üõ†Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Linux-—Å–∏—Å—Ç–µ–º–∞ —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ —è–¥—Ä–∞ (–æ–±—ã—á–Ω–æ –ø–∞–∫–µ—Ç `linux-headers-$(uname -r)`);
- –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä `gcc` –∏ `make`;
- –ü—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`root`) –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è;
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Netfilter –≤ —è–¥—Ä–µ (–≤–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–≤).

## ‚ñ∂Ô∏è –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫

1. **–°–±–æ—Ä–∫–∞ –º–æ–¥—É–ª—è**:
   ```bash
   make
2. **–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞**
    ``` sudo ip link add dummy0 type dummy
    ``` sudo ip link set dummy0 up

3. **–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è**
    ``` sudo insmod span_driver.ko src_if=wlp5s0 dst_if=dummy0

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã**
    # –í –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ ‚Äî –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ–º –∑–µ—Ä–∫–∞–ª–æ
    sudo tcpdump -i tap0 -n

    # –í –¥—Ä—É–≥–æ–º ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç—Ä–∞—Ñ–∏–∫
    ping 8.8.8.8

5. **–í—ã–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è**
    sudo rmmod span_driver


**–°—Ç—É–¥–µ–Ω—Ç**
**–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ê–≤–∏–∞—Ü–∏–æ–Ω–Ω—ã–π –ò–Ω—Å—Ç–∏—Ç—É—Ç (–ú–ê–ò)**
**–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ¬´–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞ –∏ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞¬ª**
**–ü—Ä–æ—Ñ–∏–ª—å**: ¬´–ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏¬ª
**–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ2: ¬´–°–µ—Ç–µ–≤–æ–π –¥—Ä–∞–π–≤–µ—Ä¬ª**
**2025 –≥.**